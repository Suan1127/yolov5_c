# YOLOv5n 레이어 아키텍처

이 문서는 YOLOv5n 모델의 각 레이어별 역할과 구조를 상세히 설명합니다.

## 목차

- [Backbone (0-9)](#backbone-0-9)
- [Head (10-23)](#head-10-23)
- [Detect Head (24)](#detect-head-24)
- [레이어별 채널 수 요약](#레이어별-채널-수-요약)

---

## Backbone (0-9)

Backbone은 입력 이미지에서 특징을 추출하는 부분입니다. 점진적으로 해상도를 낮추고 채널 수를 늘려가며 다중 스케일 특징을 추출합니다.

### Layer 0: Initial Conv
- **타입**: Conv2D + BatchNorm + SiLU
- **구조**: `Conv(3→16, 6×6, s=2, p=2)`
- **입력**: `(1, 3, 640, 640)` - RGB 이미지
- **출력**: `(1, 16, 320, 320)`
- **역할**: 
  - 입력 이미지의 첫 번째 다운샘플링
  - 6×6 커널로 넓은 수용 영역(receptive field) 확보
  - 채널 수를 3에서 16으로 증가

### Layer 1: Conv
- **타입**: Conv2D + BatchNorm + SiLU
- **구조**: `Conv(16→32, 3×3, s=2)`
- **입력**: `(1, 16, 320, 320)`
- **출력**: `(1, 32, 160, 160)`
- **역할**: 
  - 두 번째 다운샘플링
  - 채널 수를 32로 증가

### Layer 2: C3 Block
- **타입**: C3 (CSP Bottleneck with 3 convolutions)
- **구조**: `C3(32→32, n=1)`
- **입력**: `(1, 32, 160, 160)`
- **출력**: `(1, 32, 160, 160)`
- **역할**: 
  - 특징 추출 및 정제
  - CSP (Cross Stage Partial) 구조로 효율적인 특징 학습
  - 채널 수 유지 (32)

### Layer 3: Conv → SAVE
- **타입**: Conv2D + BatchNorm + SiLU
- **구조**: `Conv(32→64, 3×3, s=2)`
- **입력**: `(1, 32, 160, 160)`
- **출력**: `(1, 64, 80, 80)` → **SAVE[3]**
- **역할**: 
  - 세 번째 다운샘플링
  - 채널 수를 64로 증가
  - **Head의 P4 경로에서 사용** (Layer 15와 Concat)

### Layer 4: C3 Block → SAVE
- **타입**: C3
- **구조**: `C3(64→64, n=2)`
- **입력**: `(1, 64, 80, 80)`
- **출력**: `(1, 64, 80, 80)` → **SAVE[4]**
- **역할**: 
  - 특징 추출 및 정제
  - **Head의 P3 경로에서 사용** (Layer 16과 Concat)

### Layer 5: Conv → SAVE
- **타입**: Conv2D + BatchNorm + SiLU
- **구조**: `Conv(64→128, 3×3, s=2)`
- **입력**: `(1, 64, 80, 80)`
- **출력**: `(1, 128, 40, 40)` → **SAVE[5]**
- **역할**: 
  - 네 번째 다운샘플링
  - 채널 수를 128로 증가

### Layer 6: C3 Block → SAVE
- **타입**: C3
- **구조**: `C3(128→128, n=3)`
- **입력**: `(1, 128, 40, 40)`
- **출력**: `(1, 128, 40, 40)` → **SAVE[6]**
- **역할**: 
  - 특징 추출 및 정제
  - **Head의 P4 경로에서 사용** (Layer 12와 Concat)

### Layer 7: Conv → SAVE
- **타입**: Conv2D + BatchNorm + SiLU
- **구조**: `Conv(128→256, 3×3, s=2)`
- **입력**: `(1, 128, 40, 40)`
- **출력**: `(1, 256, 20, 20)` → **SAVE[7]**
- **역할**: 
  - 다섯 번째 다운샘플링
  - 채널 수를 256으로 증가

### Layer 8: C3 Block
- **타입**: C3
- **구조**: `C3(256→256, n=1)`
- **입력**: `(1, 256, 20, 20)`
- **출력**: `(1, 256, 20, 20)`
- **역할**: 
  - 특징 추출 및 정제
  - SPPF 블록으로 전달

### Layer 9: SPPF Block → SAVE
- **타입**: SPPF (Spatial Pyramid Pooling Fast)
- **구조**: `SPPF(256→256, k=5)`
- **입력**: `(1, 256, 20, 20)`
- **출력**: `(1, 256, 20, 20)` → **SAVE[9]**
- **역할**: 
  - 다양한 스케일의 특징을 통합
  - MaxPool을 여러 번 적용하여 다중 스케일 특징 추출
  - **Head의 시작점** (Layer 10으로 전달)

---

## Head (10-23)

Head는 Feature Pyramid Network (FPN) 구조로, Backbone에서 추출한 특징을 다중 스케일로 결합하여 객체 탐지를 위한 특징맵을 생성합니다.

### Layer 10: Conv (Head 시작)
- **타입**: Conv2D + BatchNorm + SiLU
- **구조**: `Conv(256→128, 1×1)`
- **입력**: `(1, 256, 20, 20)` (Layer 9 출력)
- **출력**: `(1, 128, 20, 20)`
- **역할**: 
  - 채널 수를 256에서 128로 감소 (경량화)
  - **P5 경로의 시작점**
  - **Layer 22에서 재사용** (Concat)

### Layer 11: Upsample
- **타입**: Upsample (Nearest Neighbor)
- **구조**: `Upsample(×2)`
- **입력**: `(1, 128, 20, 20)`
- **출력**: `(1, 128, 40, 40)`
- **역할**: 
  - 해상도를 2배로 증가
  - P4 경로로 전달하기 위한 준비

### Layer 12: Concat
- **타입**: Concat
- **구조**: `Concat([Layer 11, Layer 6])`
- **입력**: 
  - Layer 11: `(1, 128, 40, 40)`
  - Layer 6: `(1, 128, 40, 40)`
- **출력**: `(1, 256, 40, 40)`
- **역할**: 
  - 다운샘플링된 특징과 업샘플링된 특징을 결합
  - 다중 스케일 특징 통합

### Layer 13: C3 Block
- **타입**: C3 (shortcut=False)
- **구조**: `C3(256→128, n=1, shortcut=False)`
- **입력**: `(1, 256, 40, 40)`
- **출력**: `(1, 128, 40, 40)`
- **역할**: 
  - 결합된 특징을 정제
  - 채널 수를 128로 감소
  - **Layer 19에서 재사용** (Concat)

### Layer 14: Conv
- **타입**: Conv2D + BatchNorm + SiLU
- **구조**: `Conv(128→64, 1×1)`
- **입력**: `(1, 128, 40, 40)`
- **출력**: `(1, 64, 40, 40)`
- **역할**: 
  - 채널 수를 64로 감소
  - **P4 경로의 중간 특징**
  - **Layer 19에서 재사용** (Concat)

### Layer 15: Upsample
- **타입**: Upsample (Nearest Neighbor)
- **구조**: `Upsample(×2)`
- **입력**: `(1, 64, 40, 40)`
- **출력**: `(1, 64, 80, 80)`
- **역할**: 
  - 해상도를 2배로 증가
  - P3 경로로 전달하기 위한 준비

### Layer 16: Concat
- **타입**: Concat
- **구조**: `Concat([Layer 15, Layer 4])`
- **입력**: 
  - Layer 15: `(1, 64, 80, 80)`
  - Layer 4: `(1, 64, 80, 80)`
- **출력**: `(1, 128, 80, 80)`
- **역할**: 
  - 다운샘플링된 특징과 업샘플링된 특징을 결합
  - P3 경로의 특징 통합

### Layer 17: C3 Block → SAVE (P3)
- **타입**: C3 (shortcut=False)
- **구조**: `C3(128→64, n=1, shortcut=False)`
- **입력**: `(1, 128, 80, 80)`
- **출력**: `(1, 64, 80, 80)` → **SAVE[17] (P3)**
- **역할**: 
  - P3 특징맵 생성 완료
  - 작은 객체 탐지용 (stride=8)
  - **Detect head로 전달**

### Layer 18: Conv
- **타입**: Conv2D + BatchNorm + SiLU
- **구조**: `Conv(64→64, 3×3, s=2)`
- **입력**: `(1, 64, 80, 80)`
- **출력**: `(1, 64, 40, 40)`
- **역할**: 
  - 다운샘플링하여 P4 경로로 전달
  - 해상도를 절반으로 감소

### Layer 19: Concat
- **타입**: Concat
- **구조**: `Concat([Layer 18, Layer 14])`
- **입력**: 
  - Layer 18: `(1, 64, 40, 40)`
  - Layer 14: `(1, 64, 40, 40)`
- **출력**: `(1, 128, 40, 40)`
- **역할**: 
  - P3에서 다운샘플링된 특징과 P4 중간 특징 결합
  - P4 경로의 특징 통합

### Layer 20: C3 Block → SAVE (P4)
- **타입**: C3 (shortcut=False)
- **구조**: `C3(128→128, n=1, shortcut=False)`
- **입력**: `(1, 128, 40, 40)`
- **출력**: `(1, 128, 40, 40)` → **SAVE[20] (P4)`
- **역할**: 
  - P4 특징맵 생성 완료
  - 중간 크기 객체 탐지용 (stride=16)
  - **Detect head로 전달**

### Layer 21: Conv
- **타입**: Conv2D + BatchNorm + SiLU
- **구조**: `Conv(128→128, 3×3, s=2)`
- **입력**: `(1, 128, 40, 40)`
- **출력**: `(1, 128, 20, 20)`
- **역할**: 
  - 다운샘플링하여 P5 경로로 전달
  - 해상도를 절반으로 감소

### Layer 22: Concat
- **타입**: Concat
- **구조**: `Concat([Layer 21, Layer 10])`
- **입력**: 
  - Layer 21: `(1, 128, 20, 20)`
  - Layer 10: `(1, 128, 20, 20)`
- **출력**: `(1, 256, 20, 20)`
- **역할**: 
  - P4에서 다운샘플링된 특징과 P5 시작 특징 결합
  - P5 경로의 특징 통합

### Layer 23: C3 Block → SAVE (P5)
- **타입**: C3 (shortcut=False)
- **구조**: `C3(256→256, n=1, shortcut=False)`
- **입력**: `(1, 256, 20, 20)`
- **출력**: `(1, 256, 20, 20)` → **SAVE[23] (P5)`
- **역할**: 
  - P5 특징맵 생성 완료
  - 큰 객체 탐지용 (stride=32)
  - **Detect head로 전달**

---

## Detect Head (24)

Detect head는 P3, P4, P5 특징맵을 입력으로 받아 객체 탐지를 위한 출력을 생성합니다.

### Layer 24: Detect
- **타입**: Detect Head
- **구조**: 3개의 1×1 Conv 레이어
  - `Conv(64→255, 1×1)` for P3
  - `Conv(128→255, 1×1)` for P4
  - `Conv(256→255, 1×1)` for P5
- **입력**: 
  - P3: `(1, 64, 80, 80)` from Layer 17
  - P4: `(1, 128, 40, 40)` from Layer 20
  - P5: `(1, 256, 20, 20)` from Layer 23
- **출력**: 
  - P3: `(1, 255, 80, 80)`
  - P4: `(1, 255, 40, 40)`
  - P5: `(1, 255, 20, 20)`
- **역할**: 
  - 각 스케일의 특징맵을 탐지 출력으로 변환
  - 255 = 3 anchors × (4 bbox + 1 obj_conf + 80 class_conf)
  - 각 그리드 셀에서 3개의 앵커 박스와 클래스 확률 예측

---

## 레이어별 채널 수 요약

### Backbone
| Layer | Type | Input Channels | Output Channels | Output Shape | Save |
|-------|------|----------------|-----------------|--------------|------|
| 0 | Conv | 3 | 16 | (1, 16, 320, 320) | - |
| 1 | Conv | 16 | 32 | (1, 32, 160, 160) | - |
| 2 | C3 | 32 | 32 | (1, 32, 160, 160) | - |
| 3 | Conv | 32 | 64 | (1, 64, 80, 80) | ✓ |
| 4 | C3 | 64 | 64 | (1, 64, 80, 80) | ✓ |
| 5 | Conv | 64 | 128 | (1, 128, 40, 40) | ✓ |
| 6 | C3 | 128 | 128 | (1, 128, 40, 40) | ✓ |
| 7 | Conv | 128 | 256 | (1, 256, 20, 20) | ✓ |
| 8 | C3 | 256 | 256 | (1, 256, 20, 20) | - |
| 9 | SPPF | 256 | 256 | (1, 256, 20, 20) | ✓ |

### Head
| Layer | Type | Input Channels | Output Channels | Output Shape | Save |
|-------|------|----------------|-----------------|--------------|------|
| 10 | Conv | 256 | 128 | (1, 128, 20, 20) | - |
| 11 | Upsample | 128 | 128 | (1, 128, 40, 40) | - |
| 12 | Concat | 128+128 | 256 | (1, 256, 40, 40) | - |
| 13 | C3 | 256 | 128 | (1, 128, 40, 40) | - |
| 14 | Conv | 128 | 64 | (1, 64, 40, 40) | - |
| 15 | Upsample | 64 | 64 | (1, 64, 80, 80) | - |
| 16 | Concat | 64+64 | 128 | (1, 128, 80, 80) | - |
| 17 | C3 | 128 | 64 | (1, 64, 80, 80) | ✓ (P3) |
| 18 | Conv | 64 | 64 | (1, 64, 40, 40) | - |
| 19 | Concat | 64+64 | 128 | (1, 128, 40, 40) | - |
| 20 | C3 | 128 | 128 | (1, 128, 40, 40) | ✓ (P4) |
| 21 | Conv | 128 | 128 | (1, 128, 20, 20) | - |
| 22 | Concat | 128+128 | 256 | (1, 256, 20, 20) | - |
| 23 | C3 | 256 | 256 | (1, 256, 20, 20) | ✓ (P5) |

### Detect Head
| Scale | Input Channels | Output Channels | Output Shape | Stride |
|-------|----------------|-----------------|--------------|--------|
| P3 | 64 | 255 | (1, 255, 80, 80) | 8 |
| P4 | 128 | 255 | (1, 255, 40, 40) | 16 |
| P5 | 256 | 255 | (1, 255, 20, 20) | 32 |

---

## 특징맵 저장 위치

다음 레이어들의 출력이 저장되어 FPN 연결에 사용됩니다:

- **Layer 3**: `(1, 64, 80, 80)` → Layer 16 (Concat)에서 사용
- **Layer 4**: `(1, 64, 80, 80)` → Layer 16 (Concat)에서 사용
- **Layer 5**: `(1, 128, 40, 40)` → (사용되지 않음)
- **Layer 6**: `(1, 128, 40, 40)` → Layer 12 (Concat)에서 사용
- **Layer 7**: `(1, 256, 20, 20)` → (사용되지 않음)
- **Layer 9**: `(1, 256, 20, 20)` → Layer 10 (Conv)로 전달
- **Layer 17**: `(1, 64, 80, 80)` → **P3**, Detect head로 전달
- **Layer 20**: `(1, 128, 40, 40)` → **P4**, Detect head로 전달
- **Layer 23**: `(1, 256, 20, 20)` → **P5**, Detect head로 전달

---

## 데이터 흐름도

```
Input (640×640)
    ↓
Backbone: 다운샘플링 + 특징 추출
    ↓
Layer 9: SPPF (256, 20, 20)
    ↓
Head: FPN 구조로 다중 스케일 특징 결합
    ├─→ P3 (64, 80, 80)   [Layer 17] - 작은 객체
    ├─→ P4 (128, 40, 40)  [Layer 20] - 중간 객체
    └─→ P5 (256, 20, 20)  [Layer 23] - 큰 객체
    ↓
Detect Head: 각 스케일을 탐지 출력으로 변환
    ├─→ (255, 80, 80)   - P3 출력
    ├─→ (255, 40, 40)   - P4 출력
    └─→ (255, 20, 20)   - P5 출력
```

---

## 관련 문서

- `docs/MODULE_ARCHITECTURE.md`: 모듈별 상세 구조
- `docs/INFERENCE_FLOW.md`: 추론 흐름 상세 설명
- `docs/DETECTION_FLOW.md`: Detection 파이프라인 설명
- `TESTING.md`: 테스트 가이드
