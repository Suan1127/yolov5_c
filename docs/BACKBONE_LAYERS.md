# Backbone 레이어 상세 설명

YOLOv5n의 Backbone은 입력 이미지에서 특징을 추출하는 부분입니다. 점진적으로 해상도를 낮추고 채널 수를 늘려가며 다중 스케일 특징을 추출합니다.

## 개요

- **레이어 범위**: 0-9
- **입력**: RGB 이미지 `(1, 3, 640, 640)`
- **출력**: 특징맵 `(1, 256, 20, 20)` (Layer 9)
- **주요 역할**: 특징 추출 및 다운샘플링

---

## Layer 0: Initial Convolution

### 구조
```
Conv(3→16, 6×6, s=2, p=2) + BN + SiLU
```

### 상세 정보
- **입력**: `(1, 3, 640, 640)` - RGB 이미지
- **출력**: `(1, 16, 320, 320)`
- **파라미터**:
  - 커널 크기: 6×6
  - Stride: 2
  - Padding: 2
  - 출력 채널: 16

### 역할
- 입력 이미지의 첫 번째 다운샘플링
- 6×6 커널로 넓은 수용 영역(receptive field) 확보
- 채널 수를 3에서 16으로 증가
- SiLU 활성화 함수로 비선형성 추가

### 특징
- 큰 커널 크기(6×6)로 초기 특징 추출에 효과적
- Stride 2로 해상도를 절반으로 감소

---

## Layer 1: Convolution

### 구조
```
Conv(16→32, 3×3, s=2) + BN + SiLU
```

### 상세 정보
- **입력**: `(1, 16, 320, 320)`
- **출력**: `(1, 32, 160, 160)`
- **파라미터**:
  - 커널 크기: 3×3
  - Stride: 2
  - Padding: 1 (자동 계산)
  - 출력 채널: 32

### 역할
- 두 번째 다운샘플링
- 채널 수를 32로 증가
- 특징 추출 및 정제

---

## Layer 2: C3 Block

### 구조
```
C3(32→32, n=1)
```

### 상세 정보
- **입력**: `(1, 32, 160, 160)`
- **출력**: `(1, 32, 160, 160)`
- **파라미터**:
  - 입력 채널: 32
  - 출력 채널: 32
  - 반복 횟수: n=1 (YOLOv5n의 depth_multiple=0.33 적용)

### C3 블록 구조
```
Input (32 channels)
    ├─→ cv1: Conv(32→16, 1×1) + BN + SiLU
    │       └─→ Bottleneck × n
    │           └─→ cv2: Conv(16→16, 3×3) + BN + SiLU
    │
    └─→ cv3: Conv(32→32, 1×1) + BN + SiLU
    │
    Concat → cv3 output
```

### 역할
- CSP (Cross Stage Partial) 구조로 효율적인 특징 학습
- 채널 수 유지 (32)
- 특징 추출 및 정제

---

## Layer 3: Convolution → SAVE

### 구조
```
Conv(32→64, 3×3, s=2) + BN + SiLU
```

### 상세 정보
- **입력**: `(1, 32, 160, 160)`
- **출력**: `(1, 64, 80, 80)` → **SAVE[3]**
- **파라미터**:
  - 커널 크기: 3×3
  - Stride: 2
  - 출력 채널: 64

### 역할
- 세 번째 다운샘플링
- 채널 수를 64로 증가
- **Head의 P4 경로에서 사용** (Layer 15와 Concat)

### 저장 이유
- FPN 구조에서 업샘플링된 특징과 결합하기 위해 저장

---

## Layer 4: C3 Block → SAVE

### 구조
```
C3(64→64, n=2)
```

### 상세 정보
- **입력**: `(1, 64, 80, 80)`
- **출력**: `(1, 64, 80, 80)` → **SAVE[4]**
- **파라미터**:
  - 입력 채널: 64
  - 출력 채널: 64
  - 반복 횟수: n=2

### 역할
- 특징 추출 및 정제
- **Head의 P3 경로에서 사용** (Layer 16과 Concat)

### 저장 이유
- FPN 구조에서 업샘플링된 특징과 결합하기 위해 저장

---

## Layer 5: Convolution → SAVE

### 구조
```
Conv(64→128, 3×3, s=2) + BN + SiLU
```

### 상세 정보
- **입력**: `(1, 64, 80, 80)`
- **출력**: `(1, 128, 40, 40)` → **SAVE[5]`
- **파라미터**:
  - 커널 크기: 3×3
  - Stride: 2
  - 출력 채널: 128

### 역할
- 네 번째 다운샘플링
- 채널 수를 128로 증가

---

## Layer 6: C3 Block → SAVE

### 구조
```
C3(128→128, n=3)
```

### 상세 정보
- **입력**: `(1, 128, 40, 40)`
- **출력**: `(1, 128, 40, 40)` → **SAVE[6]**
- **파라미터**:
  - 입력 채널: 128
  - 출력 채널: 128
  - 반복 횟수: n=3

### 역할
- 특징 추출 및 정제
- **Head의 P4 경로에서 사용** (Layer 12와 Concat)

### 저장 이유
- FPN 구조에서 업샘플링된 특징과 결합하기 위해 저장

---

## Layer 7: Convolution → SAVE

### 구조
```
Conv(128→256, 3×3, s=2) + BN + SiLU
```

### 상세 정보
- **입력**: `(1, 128, 40, 40)`
- **출력**: `(1, 256, 20, 20)` → **SAVE[7]**
- **파라미터**:
  - 커널 크기: 3×3
  - Stride: 2
  - 출력 채널: 256

### 역할
- 다섯 번째 다운샘플링
- 채널 수를 256으로 증가

---

## Layer 8: C3 Block

### 구조
```
C3(256→256, n=1)
```

### 상세 정보
- **입력**: `(1, 256, 20, 20)`
- **출력**: `(1, 256, 20, 20)`
- **파라미터**:
  - 입력 채널: 256
  - 출력 채널: 256
  - 반복 횟수: n=1

### 역할
- 특징 추출 및 정제
- SPPF 블록으로 전달하기 전 특징 정제

---

## Layer 9: SPPF Block → SAVE

### 구조
```
SPPF(256→256, k=5)
```

### 상세 정보
- **입력**: `(1, 256, 20, 20)`
- **출력**: `(1, 256, 20, 20)` → **SAVE[9]**
- **파라미터**:
  - 입력 채널: 256
  - 출력 채널: 256
  - 커널 크기: k=5

### SPPF 블록 구조
```
Input (256 channels)
    ↓
cv1: Conv(256→128, 1×1) + BN + SiLU
    ↓
y1 = x
y2 = MaxPool(y1, k=5, s=1, p=2)
y3 = MaxPool(y2, k=5, s=1, p=2)
y4 = MaxPool(y3, k=5, s=1, p=2)
    ↓
Concat([y1, y2, y3, y4]) → (512 channels)
    ↓
cv2: Conv(512→256, 1×1) + BN + SiLU
    ↓
Output (256 channels)
```

### 역할
- 다양한 스케일의 특징을 통합
- MaxPool을 여러 번 적용하여 다중 스케일 특징 추출
- **Head의 시작점** (Layer 10으로 전달)

### SPPF의 장점
- SPP (Spatial Pyramid Pooling)의 빠른 버전
- 동일한 MaxPool을 재사용하여 효율적
- 다양한 수용 영역의 특징을 통합

---

## Backbone 출력 요약

| Layer | Output Shape | Channels | 해상도 | 용도 |
|-------|--------------|----------|--------|------|
| 0 | (320, 320) | 16 | 1/2 | 초기 특징 |
| 1 | (160, 160) | 32 | 1/4 | 특징 추출 |
| 2 | (160, 160) | 32 | 1/4 | 특징 정제 |
| 3 | (80, 80) | 64 | 1/8 | **FPN 연결** |
| 4 | (80, 80) | 64 | 1/8 | **FPN 연결** |
| 5 | (40, 40) | 128 | 1/16 | 특징 추출 |
| 6 | (40, 40) | 128 | 1/16 | **FPN 연결** |
| 7 | (20, 20) | 256 | 1/32 | 특징 추출 |
| 8 | (20, 20) | 256 | 1/32 | 특징 정제 |
| 9 | (20, 20) | 256 | 1/32 | **Head 시작** |

---

## 관련 문서

- `docs/LAYER_ARCHITECTURE.md`: 전체 레이어 아키텍처
- `docs/HEAD_LAYERS.md`: Head 레이어 상세 설명
- `src/blocks/c3.c`: C3 블록 구현
- `src/blocks/sppf.c`: SPPF 블록 구현
